name: Backend CI

on:
  push:
    branches: [ main ]
    paths: ['backend/**']  # Only run when backend code changes
  pull_request:
    branches: [ main ]
    paths: ['backend/**']

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: devswipe_db
          POSTGRES_USER: devswipe
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    env:
      DB_USERNAME: devswipe
      DB_PASSWORD: password
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/devswipe_db
      SPRING_DATASOURCE_USERNAME: devswipe
      SPRING_DATASOURCE_PASSWORD: password

    steps:
    # Step 1: Get your code
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Install Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # Step 3: Cache Gradle dependencies (speeds up builds)
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('backend/**/*.gradle*', 'backend/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
        
    # Step 4: Setup Firebase service account
    - name: Setup Firebase service account
      run: |
        mkdir -p backend/src/main/resources
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" > backend/src/main/resources/firebase-service-account.json
      shell: bash
      env:
        FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}

    # Step 5: Make gradlew executable
    - name: Grant execute permission for gradlew
      run: chmod +x backend/gradlew

    # Step 6: Install PostgreSQL client
    - name: Install PostgreSQL client
      run: sudo apt-get update && sudo apt-get -y install postgresql-client

    # Step 7: Wait for Postgres
    - name: Wait for Postgres
      run: |
        until pg_isready -h localhost -p 5432 -q; do
          echo "Waiting for postgres..."
          sleep 2
        done

    # Step 7: Build the application
    - name: Build Application
      run: cd backend && ./gradlew build -x test
      env:
        SPRING_PROFILES_ACTIVE: test
        DB_USERNAME: devswipe
        DB_PASSWORD: password
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/devswipe_db
        SPRING_DATASOURCE_USERNAME: devswipe
        SPRING_DATASOURCE_PASSWORD: password
      
    # Step 8: Run Unit Tests
    - name: Run Unit Tests
      run: cd backend && ./gradlew test
      env:
        SPRING_PROFILES_ACTIVE: test
        DB_USERNAME: devswipe
        DB_PASSWORD: password
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/devswipe_db
        SPRING_DATASOURCE_USERNAME: devswipe
        SPRING_DATASOURCE_PASSWORD: password
      
    # Step 9: Test Server Startup
    - name: Test Server Startup
      run: |
        cd backend
        SPRING_PROFILES_ACTIVE=test timeout 30s ./gradlew bootRun &
        SERVER_PID=$!
        sleep 15
        if ps -p $SERVER_PID > /dev/null; then
          echo "✅ Server started successfully"
          kill $SERVER_PID
        else
          echo "❌ Server failed to start"
          exit 1
        fi
        
    # Step 10: Upload JAR artifact
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: ProjectSwipe-Backend-JAR
        path: backend/build/libs/*.jar
        
    # Step 11: Upload Test Results (if tests fail)
    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: backend-test-reports
        path: backend/build/reports/tests/